// --------------------------------------------------------
// Code generated by Papyrus Java
// --------------------------------------------------------

package SettlersOfCatan;

import java.util.Scanner;

/************************************************************/
/**
 * 
 */
public class Game {
	/**
	 * 
	 */
	private Board board;

	/**
	 * Gets the game board.
	 * @return the board
	 */
	public Board getBoard() {
		return board;
	}
	/**
	 * 
	 */
	private Player[] players;
	/**
	 * 
	 */
	private int currentPlayer;
	/**
	 * 
	 */
	private int roundCount;

	/**
	 * Dice roller for the game
	 */
	private DiceRoller diceRoller;

	/**
	 * Scanner for input
	 */
	private Scanner scanner;

	public Game(int numPlayers, Scanner scanner) {
		this.board = new Board();
		this.players = new Player[numPlayers];
		this.diceRoller = new DiceRoller();
		this.currentPlayer = 0;
		this.roundCount = 0;
		this.scanner = scanner;
		
		// Initialize players
		initializePlayers();
		
		// Generate the board immediately
		this.board.generateBoard();
	}

	public void initializePlayers(){
		for (int i = 0; i < players.length; i++){
			players[i] = new Player(PlayerColor.values()[i]);
		}
	}

	/**
	 * Setup phase: each player places their first settlement.
	 * Input is taken from the console as a node id (0-53).
	 */
	public void setupInitialSettlements() {
		for (int i = 0; i < players.length; i++) {
			Player player = players[i];

			// Give just enough resources to pay for one settlement
			player.addResource(ResourceType.WOOD);
			player.addResource(ResourceType.BRICK);
			player.addResource(ResourceType.SHEEP);
			player.addResource(ResourceType.WHEAT);

			boolean placed = false;
			while (!placed) {
				System.out.println("Player " + (i + 1) + " - choose a node id (0-53) for your first settlement:");

				int nodeId;
				try {
					nodeId = Integer.parseInt(scanner.nextLine());
				} catch (NumberFormatException e) {
					System.out.println("Please enter a valid integer node id.");
					continue;
				}

				Node node = board.getNode(nodeId);
				if (node == null) {
					System.out.println("Invalid node id. Must be between 0 and 53.");
					continue;
				}

				if (!node.placeSettlement(player)) {
					System.out.println("Cannot place settlement on that node (distance rule, occupied, or not enough resources). Choose another.");
					continue;
				}

				System.out.println("Settlement placed on node " + nodeId + " for Player " + (i + 1) + ".");
				placed = true;
			}
		}
	}

	/**
	 * Starts the game. First sets up initial settlements, then runs the game loop.
	 */
	public void startGame() {
		setupInitialSettlements();
		
		// Game loop
		boolean gameRunning = true;
		while (gameRunning) {
			// Each player's turn
			for (int i = 0; i < players.length; i++) {
				currentPlayer = i;
				Player player = players[i];
				
				// Roll dice
				int diceRoll = diceRoller.rollTwoDice(6);
				System.out.println("\nPlayer " + (i + 1) + " rolled: " + diceRoll);
				
				// Distribute resources to all players
				distributeResources(diceRoll);
			}
			
			roundCount++;
			
			// Check if any player has won
			for (Player p : players) {
				if (isGameOver(p)) {
					gameRunning = false;
					break;
				}
			}
			
			// For testing purposes, limit to a few rounds
			if (roundCount >= 3) {
				System.out.println("\n=== Game ended after " + roundCount + " rounds ===");
				gameRunning = false;
			}
		}
	}

	/**
	 * Distributes resources to all players based on the dice roll.
	 * Each player with a settlement/city on a tile matching the rolled number receives resources.
	 * @param diceRoll the result of the dice roll
	 */
	private void distributeResources(int diceRoll) {
		// For each tile
		for (Tile tile : board.getTiles()) {
			// Check if tile number matches the roll
			if (tile.getNumber() == diceRoll) {
				// Get the resource type this tile produces
				ResourceType resource = tile.produceResource();
				
				// Get all nodes on this tile
				int[] nodeIds = tile.getNodeIds();
				
				// Check each node
				for (int nodeId : nodeIds) {
					Node node = board.getNode(nodeId);
					if (node != null && node.isOccupied()) {
						Player owner = node.getOccupyingPlayer();
						if (owner != null && resource != ResourceType.NULL) {
							owner.addResource(resource);
							System.out.println("Player " + (getPlayerNumber(owner) + 1) + " received " + resource + " from tile at node " + nodeId);
						}
					}
				}
			}
		}
	}

	/**
	 * Gets the index of a player in the players array.
	 * @param player the player to find
	 * @return the index of the player, or -1 if not found
	 */
	private int getPlayerNumber(Player player) {
		for (int i = 0; i < players.length; i++) {
			if (players[i] == player) {
				return i;
			}
		}
		return -1;
	}

	private void playRound() {

	}

	/**
	 * 
	 */
	public void playTurn() {

	}

	/**
	 * 
	 * @return 
	 */
	public boolean isGameOver(Player player) {
		if (player.getVictoryPoints() >= 10){
			return true;
		}
		return false;
	}

	/**
	 * 
	 * @return 
	 */
	public Player getWinner() {
		for (Player p: players){
			if (isGameOver(p)){
				return p;
			}
		}
		return null;
	}

	/**
	 * 
	 */
	public void getCurrentState() {

	}
}